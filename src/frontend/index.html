<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kallbad Trip - Bathing Sites Map</title>
    <link rel="stylesheet" href="./css/stylesheet.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }
        .site-popup { max-width: 200px; }
        .site-name { font-weight: bold; margin-bottom: 5px; }
        .site-coords { font-size: 0.8em; color: #666; }
        .info-panel { 
            position: absolute; 
            top: 10px; 
            right: 10px; 
            background: white; 
            padding: 15px; 
            border-radius: 5px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); 
            z-index: 1000; 
            max-width: 300px; 
        }
        .loading { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            background: white; 
            padding: 20px; 
            border-radius: 5px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); 
            z-index: 1000; 
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <div id="loading" class="loading">
        <h3>üó∫Ô∏è Kallbad-Trip</h3>
        <p>Loading bathing sites...</p>
    </div>
    
    <div id="info" class="info-panel" style="display: none;">
        <h3>üó∫Ô∏è Kallbad-Trip</h3>
        <p><strong>Status:</strong> <span id="status">Loading...</span></p>
        <p><strong>Sites loaded:</strong> <span id="siteCount">0</span></p>
        <p><strong>Note:</strong> Real-time data from HaV API</p>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Map configuration
        const map = L.map('map').setView([59.3293, 18.0686], 6); // Centered on Sweden
        
        // Add tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);
        
        // Bathing site markers
        const bathingSites = new Map();
        
        // Function to retrieve sites in the visible area
        async function loadSitesInView() {
            const bounds = map.getBounds();
            const boundsParam = JSON.stringify({
                north: bounds.getNorth(),
                south: bounds.getSouth(),
                east: bounds.getEast(),
                west: bounds.getWest()
            });
            
            try {
                const response = await fetch(`/api/bathing-waters?bounds=${encodeURIComponent(boundsParam)}&limit=200`);
                const data = await response.json();
                
                if (data.success) {
                    // Supprimer les anciens marqueurs
                    bathingSites.forEach(marker => map.removeLayer(marker));
                    bathingSites.clear();
                    
                    // Ajouter les nouveaux marqueurs
                    data.data.forEach(site => {
                        const marker = L.marker([site.coordinates.latitude, site.coordinates.longitude])
                            .addTo(map)
                            .bindPopup(`
                                <div class="site-popup">
                                    <div class="site-name">${site.name}</div>
                                    <div class="site-coords">
                                        ${site.coordinates.latitude.toFixed(4)}, ${site.coordinates.longitude.toFixed(4)}
                                    </div>
                                    <button onclick="showSiteDetails('${site.id}')" style="margin-top: 5px; padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">
                                        View details
                                    </button>
                                </div>
                            `);
                        
                        // Store marker with site ID
                        marker.siteId = site.id;
                        bathingSites.set(site.id, marker);
                    });
                    
                    document.getElementById('status').textContent = 'Sites loaded successfully';
                    document.getElementById('siteCount').textContent = data.data.length;
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('info').style.display = 'block';
                    
                        console.log(`‚úÖ ${data.data.length} sites loaded in visible area`);
                } else {
                    // If no data, display a message
                    document.getElementById('status').textContent = 'No sites found in this area';
                    document.getElementById('siteCount').textContent = '0';
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('info').style.display = 'block';
                }
            } catch (error) {
                console.error('‚ùå Error loading sites:', error);
                document.getElementById('status').textContent = 'Loading error';
                document.getElementById('loading').style.display = 'none';
                document.getElementById('info').style.display = 'block';
            }
        }
        
        
        // Function to display site details
        async function showSiteDetails(siteId) {
            try {
                console.log(`üîç Attempting to retrieve details for site: ${siteId}`);
                
                // Show loading indicator
                const marker = bathingSites.get(siteId);
                if (marker) {
                    marker.setPopupContent(`
                        <div style="text-align: center; padding: 10px;">
                            <div style="margin-bottom: 10px;">üîÑ</div>
                            <div>Loading details...</div>
                            <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                                Translating content to English
                            </div>
                        </div>
                    `).openPopup();
                }
                
                const response = await fetch(`/api/bathing-waters/${siteId}/profile`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    console.log(`‚úÖ Details found for ${siteId}:`, data.data);
                    showSiteDetailsPopup(data.data);
                } else {
                    console.log(`‚ö†Ô∏è No details available for ${siteId}, using basic data`);
                    const basicSite = Array.from(bathingSites.values()).find(marker => marker.siteId === siteId);
                    if (basicSite) {
                        showBasicSiteDetails(siteId, basicSite);
                    }
                }
            } catch (error) {
                console.log(`‚ùå Error loading details for ${siteId}:`, error.message);
                // In case of error, display basic information
                const basicSite = Array.from(bathingSites.values()).find(marker => marker.siteId === siteId);
                if (basicSite) {
                    showBasicSiteDetails(siteId, basicSite);
                }
            }
        }
        
        // Function to display complete details
        function showSiteDetailsPopup(site) {
            const detailPopup = `
                <div style="max-width: 300px;">
                    <h3>${site.name}</h3>
                    <p><strong>Type:</strong> ${site.waterType.name}</p>
                    <p><strong>Description:</strong> ${site.description ? site.description.substring(0, 200) + '...' : 'No description available'}</p>
                    ${site.bathingSeason ? `
                        <p><strong>Season:</strong> ${site.bathingSeason.isActive ? 'Active' : 'Closed'}</p>
                    ` : ''}
                    ${site.waterQuality ? `
                        <p><strong>Quality:</strong> ${site.waterQuality.currentClassification?.qualityClassIdText || 'Not available'}</p>
                        ${site.waterQuality.hasAlgae ? '<p style="color: orange;">‚ö†Ô∏è Algae present</p>' : ''}
                        ${site.waterQuality.hasCyanobacteria ? '<p style="color: red;">‚ö†Ô∏è Cyanobacteria detected</p>' : ''}
                    ` : ''}
                </div>
            `;
            
            // Find marker and open popup
            const marker = bathingSites.get(site.id);
            if (marker) {
                marker.setPopupContent(detailPopup).openPopup();
            }
        }
        
        // Function to display basic details
        function showBasicSiteDetails(siteId, marker) {
            const siteName = marker.getPopup().getContent().match(/<div class="site-name">(.*?)<\/div>/)?.[1] || 'Bathing site';
            const coords = marker.getLatLng();
            
            const basicPopup = `
                <div style="max-width: 300px;">
                    <h3>üèä ${siteName}</h3>
                    <hr style="margin: 10px 0; border: 1px solid #eee;">
                    <p><strong>üìç Coordinates:</strong><br>
                    Latitude: ${coords.lat.toFixed(6)}<br>
                    Longitude: ${coords.lng.toFixed(6)}</p>
                    <p><strong>üÜî Identifier:</strong><br>
                    ${siteId}</p>
                    <hr style="margin: 10px 0; border: 1px solid #eee;">
                    <p style="color: #666; font-style: italic;">
                        ‚ÑπÔ∏è Detailed information not available via HaV API for this site.
                    </p>
                    <p style="color: #666; font-size: 0.9em;">
                        This bathing site is part of the official Swedish network.
                    </p>
                </div>
            `;
            
            marker.setPopupContent(basicPopup).openPopup();
        }
        
        // Load sites on startup
        loadSitesInView();
        
        // Reload sites when map moves (with debounce)
        let moveTimeout;
        map.on('moveend', () => {
            clearTimeout(moveTimeout);
            moveTimeout = setTimeout(loadSitesInView, 500);
        });
        
        // Reload sites when zooming
        map.on('zoomend', () => {
            clearTimeout(moveTimeout);
            moveTimeout = setTimeout(loadSitesInView, 500);
        });
        
        console.log('üó∫Ô∏è Bathing sites map initialized');
    </script>
</body>

</html>