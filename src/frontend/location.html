<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kallbad Trip</title>
    <link rel="stylesheet" href="./css/stylesheet.css">
</head>
<body>
    <div class="site-header">
    <h1>Kallbad Trip</h1>
    </div>

        <div class="main">
            <p id="status">Loading...</p>
            <div id="siteInfo"></div>
            <p><a class="back-link" href="./index.html">← Back to map</a></p>
        </div>

        <script>
            async function renderSite() {
                const params = new URLSearchParams(window.location.search);
                const id = params.get('id');
                const statusEl = document.getElementById('status');
                const infoEl = document.getElementById('siteInfo');

                if (!id) {
                    statusEl.textContent = 'No site selected. Return to the map and click "View details" on a marker.';
                    return;
                }

                try {
                    statusEl.textContent = 'Fetching site information...';

                    // Fetch profile only — results/monitoring call removed because it is unreliable
                    const profileRes = await fetch(`http://localhost:3000/api/bathing-waters/${encodeURIComponent(id)}/profile`).catch(e => ({ ok:false, json: async ()=> ({ success:false, error: e }) }));
                    const profileJson = profileRes && profileRes.ok ? await profileRes.json() : { success: false };

                    // If profile succeeded
                    if (profileJson && profileJson.success) {
                        const site = profileJson.data;
                        statusEl.textContent = '';
                        infoEl.innerHTML = `
                            <div class="card">
                                <h2>${site.name || '—'}</h2>
                                <p class="muted"><strong>ID:</strong> ${site.id || '—'}</p>
                                <p><strong>Description:</strong> ${site.description || 'No description available.'}</p>
                                <p><strong>Summary:</strong> ${site.summary || '—'}</p>
                                <p><strong>Water type:</strong> ${site.waterType?.name || '—'}</p>
                                <p><strong>Coordinates:</strong> ${site.coordinates?.latitude || '—'}, ${site.coordinates?.longitude || '—'}</p>
                                <h3>Bathing season</h3>
                                <p>${site.bathingSeason ? `${site.bathingSeason.startDate || ''} → ${site.bathingSeason.endDate || ''} (${site.bathingSeason.isActive ? 'active' : 'inactive'})` : 'Information not available'}</p>
                                <h3>Pollution sources</h3>
                                <p>${(site.pollutionSources && site.pollutionSources.length) ? site.pollutionSources.join(', ') : 'No information'}</p>
                                <h3>Administrative authority</h3>
                                <p>${site.administrativeAuthority?.contactInfo?.name || '—'}</p>
                                <p>${site.administrativeAuthority?.contactInfo?.email ? `<a href="mailto:${site.administrativeAuthority.contactInfo.email}">${site.administrativeAuthority.contactInfo.email}</a>` : ''}</p>
                            </div>
                        `;

                        return;
                    }

                    // If profile failed, try to fallback to the map listing for basic info
                    console.warn('Profile endpoint failed or returned no data:', profileJson);
                    statusEl.textContent = 'Detailed profile unavailable — trying to fetch basic information...';

                    const listRes = await fetch('http://localhost:3000/api/bathing-waters?limit=5000&page=1');
                    const listJson = await listRes.json();
                    const found = (listJson.data || []).find(s => s.id === id);

                    if (found) {
                        statusEl.textContent = '';
                        infoEl.innerHTML = `
                            <div class="card">
                                <h2>${found.name || '—'}</h2>
                                <p class="muted"><strong>ID:</strong> ${found.id || '—'}</p>
                                <p><strong>Coordinates:</strong> ${found.coordinates?.latitude || '—'}, ${found.coordinates?.longitude || '—'}</p>
                                <p>Detailed profile is not available for this site, but here are the basic data from the listing.</p>
                            </div>
                        `;

                        return;
                    }

                    statusEl.textContent = 'Unable to retrieve site information.';
                    console.error('Profile fetch result:', profileJson);

                } catch (err) {
                    statusEl.textContent = 'Error fetching data.';
                    console.error(err);
                }
            }

            // Run on load
            document.addEventListener('DOMContentLoaded', renderSite);
        </script>
        
</body>
</html>
